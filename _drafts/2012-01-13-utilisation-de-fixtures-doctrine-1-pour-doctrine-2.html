---
layout: post
title: Utilisation de fixtures Doctrine 1 pour Doctrine 2
categories:
- Labo
- Petits trucs pour...
tags:
- Doctrine
- Fixtures
- PHP
- Symfony
- YAML
status: publish
type: post
published: true
meta:
  _edit_last: '1'
  _syntaxhighlighter_encoded: '1'
  brunelleschi_featured_post_position: left
  brunelleschi_featured_post_width: 1/4 Width
  _social_aggregated_ids: a:2:{s:7:"twitter";a:2:{i:0;s:18:"157954396897021953";i:1;s:18:"158183126529609728";}s:8:"facebook";a:0:{}}
  _social_notify: '1'
  _social_aggregation_log: a:10:{i:1326495272;O:8:"stdClass":2:{s:6:"manual";s:0:"";s:5:"items";a:1:{s:7:"twitter";a:1:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"157954396897021953";s:4:"type";s:3:"url";s:7:"ignored";s:0:"";s:4:"data";a:1:{s:8:"username";s:6:"talus_";}}}}}i:1326497072;O:8:"stdClass":2:{s:6:"manual";s:0:"";s:5:"items";a:1:{s:7:"twitter";a:1:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"157954396897021953";s:4:"type";s:3:"url";s:7:"ignored";s:1:"1";s:4:"data";a:1:{s:8:"username";s:6:"talus_";}}}}}i:1326499772;O:8:"stdClass":2:{s:6:"manual";s:0:"";s:5:"items";a:1:{s:7:"twitter";a:1:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"157954396897021953";s:4:"type";s:3:"url";s:7:"ignored";s:1:"1";s:4:"data";a:1:{s:8:"username";s:6:"talus_";}}}}}i:1326503372;O:8:"stdClass":2:{s:6:"manual";s:0:"";s:5:"items";a:1:{s:7:"twitter";a:1:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"157954396897021953";s:4:"type";s:3:"url";s:7:"ignored";s:1:"1";s:4:"data";a:1:{s:8:"username";s:6:"talus_";}}}}}i:1326510572;O:8:"stdClass":2:{s:6:"manual";s:0:"";s:5:"items";a:1:{s:7:"twitter";a:1:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"157954396897021953";s:4:"type";s:3:"url";s:7:"ignored";s:1:"1";s:4:"data";a:1:{s:8:"username";s:6:"talus_";}}}}}i:1326524973;O:8:"stdClass":2:{s:6:"manual";s:0:"";s:5:"items";a:1:{s:7:"twitter";a:1:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"157954396897021953";s:4:"type";s:3:"url";s:7:"ignored";s:1:"1";s:4:"data";a:1:{s:8:"username";s:6:"talus_";}}}}}i:1326553937;O:8:"stdClass":2:{s:6:"manual";s:0:"";s:5:"items";a:1:{s:7:"twitter";a:2:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"158183126529609728";s:4:"type";s:3:"url";s:7:"ignored";s:0:"";s:4:"data";a:1:{s:8:"username";s:14:"jordanevaspard";}}i:1;O:8:"stdClass":4:{s:2:"id";s:18:"157954396897021953";s:4:"type";s:3:"url";s:7:"ignored";s:1:"1";s:4:"data";a:1:{s:8:"username";s:6:"talus_";}}}}}i:1326598331;O:8:"stdClass":2:{s:6:"manual";s:0:"";s:5:"items";a:1:{s:7:"twitter";a:2:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"158183126529609728";s:4:"type";s:3:"url";s:7:"ignored";s:1:"1";s:4:"data";a:1:{s:8:"username";s:14:"jordanevaspard";}}i:1;O:8:"stdClass":4:{s:2:"id";s:18:"157954396897021953";s:4:"type";s:3:"url";s:7:"ignored";s:1:"1";s:4:"data";a:1:{s:8:"username";s:6:"talus_";}}}}}i:1326685954;O:8:"stdClass":2:{s:6:"manual";s:0:"";s:5:"items";a:1:{s:7:"twitter";a:2:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"158183126529609728";s:4:"type";s:3:"url";s:7:"ignored";s:1:"1";s:4:"data";a:1:{s:8:"username";s:14:"jordanevaspard";}}i:1;O:8:"stdClass":4:{s:2:"id";s:18:"157954396897021953";s:4:"type";s:3:"url";s:7:"ignored";s:1:"1";s:4:"data";a:1:{s:8:"username";s:6:"talus_";}}}}}i:1326859924;O:8:"stdClass":2:{s:6:"manual";s:0:"";s:5:"items";a:1:{s:7:"twitter";a:2:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"158183126529609728";s:4:"type";s:3:"url";s:7:"ignored";s:1:"1";s:4:"data";a:1:{s:8:"username";s:14:"jordanevaspard";}}i:1;O:8:"stdClass":4:{s:2:"id";s:18:"157954396897021953";s:4:"type";s:3:"url";s:7:"ignored";s:1:"1";s:4:"data";a:1:{s:8:"username";s:6:"talus_";}}}}}}
---
<a href="http://baptiste.xn--clavi-fsa.net/wp-content/uploads/2012/01/Doctrine_logo_white1.png"><img class="aligncenter size-full wp-image-457" title="Doctrine_logo_white" src="http://baptiste.xn--clavi-fsa.net/wp-content/uploads/2012/01/Doctrine_logo_white1.png" alt="" width="191" height="53" /></a>
<p style="text-align: justify;">Bonjour à tous,</p>
<p style="text-align: justify;">Etant en train de développer avec Doctrine 2 en ce moment, en adaptant un début de projet que j'avais alors fait sous symfony 1 (et que je passe du coup en Symfony 2), j'avais fait à l'époque des fixtures en YAML pour avoir des jeux de tests.</p>
<p style="text-align: justify;">Seul petit problème, c'est que Doctrine 2 (et par extension, Symfony 2) n'embarque plus de solution pour importer facilement des jeux de tests, et encore moins en YAML... En fouinant un peu, j'ai trouvé l'extension Doctrine 2 <a href="https://github.com/doctrine/data-fixtures">data-fixtures</a>, justement nommé... <a href="https://github.com/symfony/DoctrineFixturesBundle">DoctrineFixturesBundle</a>.</p>
<p style="text-align: justify;">Une fois le truc installé, et <a href="http://symfony.com/doc/current/bundles/DoctrineFixturesBundle/index.html">un peu de doc lue</a>, le truc, c'est qu'on se retrouve avec des classes PHP pour charger les différentes données... Ce qui ne nous convient pas, nous qui avons les fichiers YAML encore en stock. Réécrire le tout à la main ? Pwah ! Trop de boulot...</p>
<p style="text-align: justify;">Alors j'ai réuni le bundle pré-cité, et utilisé... Le composant YAML de Symfony 2. Au moins, j'ai toutes mes données (dans un array), et je n'ai plus qu'a faire une boucle dessus pour avoir des données consistantes plutôt que des données bidons. :)</p>
<p style="text-align: justify;">J'ai développé une classe de base pour pouvoir justement charger les fixtures, que j'étends pour chaque objet que je veux charger, qui me donne donc une méthode pour transformer en array le contenu d'un fichier YAML. Je préviens, c'est tout con, mais moi ça m'a servi...</p>
[sourcecode language="php"]
namespace Talus\MyBundle\DataFixtures;

use Doctrine\Common\DataFixtures\AbstractFixture,
    Doctrine\Common\DataFixtures\OrderedFixtureInterface;

use Symfony\Component\Yaml\Parser;

abstract class LoadDatasFromYamlFile extends AbstractFixture implements OrderedFixtureInterface {
    /**
     * Loads datas from a fixture file from doctrine 1
     * 
     * @param string $file file name
     * @return array
     */
    final protected function loadFromFile($file) {
        $yaml = new Parser;
        return $yaml-&gt;parse(file_get_contents(__DIR__ . '/yaml/' . $file . '.yml'));
    }
}
[/sourcecode]

<p style="text-align: justify;">Encore une fois, c'est tout con, mais je le laisse là, ça peut servir... Evidemment, pensez à changer le nom du namespace.</p>
