---
layout: post
title: Ne pas se moquer des mocks !
categories:
- Labo
tags:
- Behat
- Doctrine
- Mock
- PHPUnit
- Qualité
- Symfony
- Traits
status: publish
type: post
published: true
meta:
  _edit_last: '1'
  _social_aggregated_ids: a:2:{s:7:"twitter";a:1:{i:0;s:18:"285176211301335040";}s:8:"facebook";a:0:{}}
  _social_notify: '1'
  _social_broadcast_content: ! 'a:1:{s:7:"twitter";a:1:{i:79756673;s:101:"Nouvel article
    sur mon blog : Ne pas se moquer des mocks ! - http://baptiste.xn--clavi-fsa.net/?p=504";}}'
  _social_broadcast_meta: a:1:{s:7:"twitter";a:1:{i:79756673;a:0:{}}}
  _social_aggregation_log: a:20:{i:1356805595;O:8:"stdClass":1:{s:6:"manual";b:0;}i:1356807899;O:8:"stdClass":1:{s:6:"manual";b:0;}i:1356812795;O:8:"stdClass":1:{s:6:"manual";b:0;}i:1356816310;O:8:"stdClass":1:{s:6:"manual";b:0;}i:1356819977;O:8:"stdClass":1:{s:6:"manual";b:0;}i:1356827183;O:8:"stdClass":2:{s:6:"manual";b:0;s:5:"items";a:1:{s:7:"twitter";a:1:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"285176211301335040";s:4:"type";s:7:"retweet";s:7:"ignored";b:0;s:4:"data";a:1:{s:8:"username";s:9:"gmajoulet";}}}}}i:1356841676;O:8:"stdClass":2:{s:6:"manual";b:0;s:5:"items";a:1:{s:7:"twitter";a:1:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"285176211301335040";s:4:"type";s:7:"retweet";s:7:"ignored";b:1;s:4:"data";a:1:{s:8:"username";s:9:"gmajoulet";}}}}}i:1356871905;O:8:"stdClass":2:{s:6:"manual";b:0;s:5:"items";a:1:{s:7:"twitter";a:1:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"285176211301335040";s:4:"type";s:7:"retweet";s:7:"ignored";b:1;s:4:"data";a:1:{s:8:"username";s:9:"gmajoulet";}}}}}i:1356916804;O:8:"stdClass":2:{s:6:"manual";b:0;s:5:"items";a:1:{s:7:"twitter";a:1:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"285176211301335040";s:4:"type";s:7:"retweet";s:7:"ignored";b:1;s:4:"data";a:1:{s:8:"username";s:9:"gmajoulet";}}}}}i:1357004349;O:8:"stdClass":2:{s:6:"manual";b:0;s:5:"items";a:1:{s:7:"twitter";a:1:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"285176211301335040";s:4:"type";s:7:"retweet";s:7:"ignored";b:1;s:4:"data";a:1:{s:8:"username";s:9:"gmajoulet";}}}}}i:1357127610;O:8:"stdClass":2:{s:6:"manual";b:0;s:5:"items";a:1:{s:7:"twitter";a:1:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"285176211301335040";s:4:"type";s:7:"retweet";s:7:"ignored";b:1;s:4:"data";a:1:{s:8:"username";s:9:"gmajoulet";}}}}}i:1357130013;O:8:"stdClass":2:{s:6:"manual";b:0;s:5:"items";a:1:{s:7:"twitter";a:1:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"285176211301335040";s:4:"type";s:7:"retweet";s:7:"ignored";b:1;s:4:"data";a:1:{s:8:"username";s:9:"gmajoulet";}}}}}i:1357132921;O:8:"stdClass":2:{s:6:"manual";b:0;s:5:"items";a:1:{s:7:"twitter";a:1:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"285176211301335040";s:4:"type";s:7:"retweet";s:7:"ignored";b:1;s:4:"data";a:1:{s:8:"username";s:9:"gmajoulet";}}}}}i:1357136848;O:8:"stdClass":2:{s:6:"manual";b:0;s:5:"items";a:1:{s:7:"twitter";a:1:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"285176211301335040";s:4:"type";s:7:"retweet";s:7:"ignored";b:1;s:4:"data";a:1:{s:8:"username";s:9:"gmajoulet";}}}}}i:1357144267;O:8:"stdClass":2:{s:6:"manual";b:0;s:5:"items";a:1:{s:7:"twitter";a:1:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"285176211301335040";s:4:"type";s:7:"retweet";s:7:"ignored";b:1;s:4:"data";a:1:{s:8:"username";s:9:"gmajoulet";}}}}}i:1357159704;O:8:"stdClass":2:{s:6:"manual";b:0;s:5:"items";a:1:{s:7:"twitter";a:1:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"285176211301335040";s:4:"type";s:7:"retweet";s:7:"ignored";b:1;s:4:"data";a:1:{s:8:"username";s:9:"gmajoulet";}}}}}i:1357189525;O:8:"stdClass":2:{s:6:"manual";b:0;s:5:"items";a:1:{s:7:"twitter";a:1:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"285176211301335040";s:4:"type";s:7:"retweet";s:7:"ignored";b:1;s:4:"data";a:1:{s:8:"username";s:9:"gmajoulet";}}}}}i:1357236778;O:8:"stdClass":2:{s:6:"manual";b:0;s:5:"items";a:1:{s:7:"twitter";a:1:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"285176211301335040";s:4:"type";s:7:"retweet";s:7:"ignored";b:1;s:4:"data";a:1:{s:8:"username";s:9:"gmajoulet";}}}}}i:1357323975;O:8:"stdClass":2:{s:6:"manual";b:0;s:5:"items";a:1:{s:7:"twitter";a:1:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"285176211301335040";s:4:"type";s:7:"retweet";s:7:"ignored";b:1;s:4:"data";a:1:{s:8:"username";s:9:"gmajoulet";}}}}}i:1357496799;O:8:"stdClass":2:{s:6:"manual";b:0;s:5:"items";a:1:{s:7:"twitter";a:1:{i:0;O:8:"stdClass":4:{s:2:"id";s:18:"285176211301335040";s:4:"type";s:7:"retweet";s:7:"ignored";b:1;s:4:"data";a:1:{s:8:"username";s:9:"gmajoulet";}}}}}}
  _social_broadcasted_ids: a:1:{s:7:"twitter";a:1:{i:79756673;a:1:{s:18:"285082360444223488";a:3:{s:7:"message";s:2728:"eyJ1c2VyIjp7ImlkIjoiNzk3NTY2NzMiLCJsb2NhdGlvbiI6IlBhcmlzLCBGcmFuY2UiLCJwcm9maWxlX2ltYWdlX3VybF9odHRwcyI6Imh0dHBzOlwvXC9zaTAudHdpbWcuY29tXC9wcm9maWxlX2ltYWdlc1wvMjg4NTI0MDIzOFwvMTA5MzVkMDdlNjgwODViMzlhNGFjMDkxMjQzYjhhN2Rfbm9ybWFsLmpwZWciLCJwcm9maWxlX2ltYWdlX3VybCI6Imh0dHA6XC9cL2EwLnR3aW1nLmNvbVwvcHJvZmlsZV9pbWFnZXNcLzI4ODUyNDAyMzhcLzEwOTM1ZDA3ZTY4MDg1YjM5YTRhYzA5MTI0M2I4YTdkX25vcm1hbC5qcGVnIiwiZm9sbG93aW5nIjpmYWxzZSwiZGVmYXVsdF9wcm9maWxlX2ltYWdlIjpmYWxzZSwiZmF2b3VyaXRlc19jb3VudCI6MCwicHJvZmlsZV9iYWNrZ3JvdW5kX2NvbG9yIjoiQzZFMkVFIiwidXRjX29mZnNldCI6MzYwMCwibmFtZSI6IkJhcHRpc3RlIENsYXZpXHUwMGU5IiwicHJvZmlsZV9iYWNrZ3JvdW5kX2ltYWdlX3VybCI6Imh0dHA6XC9cL2EwLnR3aW1nLmNvbVwvaW1hZ2VzXC90aGVtZXNcL3RoZW1lMlwvYmcuZ2lmIiwic3RhdHVzZXNfY291bnQiOjU2NDYsInByb2ZpbGVfbGlua19jb2xvciI6IjFGOThDNyIsInByb3RlY3RlZCI6ZmFsc2UsInZlcmlmaWVkIjpmYWxzZSwiY29udHJpYnV0b3JzX2VuYWJsZWQiOmZhbHNlLCJkZWZhdWx0X3Byb2ZpbGUiOmZhbHNlLCJwcm9maWxlX3VzZV9iYWNrZ3JvdW5kX2ltYWdlIjp0cnVlLCJjcmVhdGVkX2F0IjoiU3VuIE9jdCAwNCAxNTozNDo0MyArMDAwMCAyMDA5IiwidGltZV96b25lIjoiUGFyaXMiLCJwcm9maWxlX2JhY2tncm91bmRfaW1hZ2VfdXJsX2h0dHBzIjoiaHR0cHM6XC9cL3NpMC50d2ltZy5jb21cL2ltYWdlc1wvdGhlbWVzXC90aGVtZTJcL2JnLmdpZiIsInByb2ZpbGVfdGV4dF9jb2xvciI6IjY2M0IxMiIsImlkX3N0ciI6Ijc5NzU2NjczIiwiaXNfdHJhbnNsYXRvciI6ZmFsc2UsImZvbGxvd2Vyc19jb3VudCI6Mjg2LCJnZW9fZW5hYmxlZCI6dHJ1ZSwidXJsIjoiaHR0cDpcL1wvYmFwdGlzdGUuY2xhdmlcdTAwZTkubmV0IiwibGFuZyI6ImVuIiwibm90aWZpY2F0aW9ucyI6ZmFsc2UsInByb2ZpbGVfc2lkZWJhcl9ib3JkZXJfY29sb3IiOiJDNkUyRUUiLCJsaXN0ZWRfY291bnQiOjE3LCJzY3JlZW5fbmFtZSI6InRhbHVzXyIsInByb2ZpbGVfYmFja2dyb3VuZF90aWxlIjpmYWxzZSwiZm9sbG93X3JlcXVlc3Rfc2VudCI6ZmFsc2UsImRlc2NyaXB0aW9uIjoiRnJlbmNoIElUIEVuZ2luZWVyIChNYXN0ZXIgZGVncmVlKSwgc3BlY2lhbGl6ZWQgaW4gU29mdHdhcmUgRW5naW5lZXJpbmcuIEknbSBhIFdlYiBFbnRodXNpYXN0LiBQcm9iYWJseS4gV2VsbCwgSSBndWVzcyBhbnl3YXkuIEN1cnJlbnRseSB3b3JraW5nIEB3aXNlbWJseSIsInByb2ZpbGVfc2lkZWJhcl9maWxsX2NvbG9yIjoiREFFQ0Y0IiwiZnJpZW5kc19jb3VudCI6NDUyfSwiY29udHJpYnV0b3JzIjpudWxsLCJjb29yZGluYXRlcyI6bnVsbCwiZ2VvIjpudWxsLCJyZXR3ZWV0ZWQiOmZhbHNlLCJyZXR3ZWV0X2NvdW50IjowLCJpbl9yZXBseV90b191c2VyX2lkIjpudWxsLCJpbl9yZXBseV90b19zdGF0dXNfaWQiOm51bGwsImNyZWF0ZWRfYXQiOiJTYXQgRGVjIDI5IDE3OjU4OjI1ICswMDAwIDIwMTIiLCJwb3NzaWJseV9zZW5zaXRpdmUiOmZhbHNlLCJpZF9zdHIiOiIyODUwODIzNjA0NDQyMjM0ODgiLCJpbl9yZXBseV90b19zY3JlZW5fbmFtZSI6bnVsbCwiaW5fcmVwbHlfdG9fc3RhdHVzX2lkX3N0ciI6bnVsbCwiZmF2b3JpdGVkIjpmYWxzZSwidHJ1bmNhdGVkIjpmYWxzZSwidGV4dCI6Ik5vdXZlbCBhcnRpY2xlIHN1ciBtb24gYmxvZyA6IE5lIHBhcyBzZSBtb3F1ZXIgZGVzIG1vY2tzICEgLSBodHRwOlwvXC90LmNvXC9OVGNnT3pDViIsInBsYWNlIjpudWxsLCJzb3VyY2UiOiI8YSBocmVmPVwiaHR0cHM6XC9cL3NvcHJlc3RvLm1haWxjaGltcC5jb21cIiByZWw9XCJub2ZvbGxvd1wiPlNvY2lhbCBQcm94eSBieSBNYWlsY2hpbXA8XC9hPiIsImluX3JlcGx5X3RvX3VzZXJfaWRfc3RyIjpudWxsLCJpZCI6IjI4NTA4MjM2MDQ0NDIyMzQ4OCJ9";s:4:"urls";a:2:{i:0;s:66:"http://baptiste.xn--clavi-fsa.net/labo/ne-pas-se-moquer-des-mocks/";i:1;s:40:"http://baptiste.xn--clavi-fsa.net/?p=504";}s:7:"account";O:8:"stdClass":1:{s:4:"user";O:8:"stdClass":39:{s:12:"listed_count";s:2:"15";s:8:"verified";s:0:"";s:13:"notifications";s:0:"";s:9:"time_zone";s:5:"Paris";s:9:"protected";s:0:"";s:19:"follow_request_sent";s:0:"";s:28:"profile_sidebar_border_color";s:6:"D3D2CF";s:8:"location";s:5:"Paris";s:4:"name";s:16:"Baptiste
    Clavié";s:15:"default_profile";s:0:"";s:28:"profile_use_background_image";s:1:"1";s:10:"utc_offset";s:4:"3600";s:15:"followers_count";s:3:"228";s:3:"url";s:27:"http://baptiste.clavié.net";s:17:"profile_image_url";s:90:"http://a1.twimg.com/profile_images/1399907993/2824ef746269b35091240ed6e66e21a5_normal.jpeg";s:11:"description";s:122:"French
    IT student (Master degree), specialized in Software Engineering at @EFREI_officiel.
    Self-declared Web Enthusiast :)";s:6:"id_str";s:8:"79756673";s:21:"default_profile_image";s:0:"";s:14:"statuses_count";s:4:"4254";s:9:"following";s:0:"";s:13:"friends_count";s:3:"313";s:18:"profile_text_color";s:6:"634047";s:28:"profile_background_image_url";s:47:"http://a1.twimg.com/images/themes/theme3/bg.gif";s:6:"status";O:8:"stdClass":18:{s:5:"place";s:0:"";s:9:"favorited";s:0:"";s:13:"retweet_count";s:1:"0";s:23:"in_reply_to_screen_name";s:13:"cyprienlaleau";s:6:"id_str";s:18:"137689141386293248";s:9:"retweeted";s:0:"";s:25:"in_reply_to_status_id_str";s:18:"137688507551457280";s:3:"geo";s:0:"";s:11:"coordinates";s:0:"";s:19:"in_reply_to_user_id";s:9:"404311880";s:21:"in_reply_to_status_id";s:19:"1.3768850755146E+17";s:10:"created_at";s:30:"Sat
    Nov 19 00:30:24 +0000 2011";s:23:"in_reply_to_user_id_str";s:9:"404311880";s:6:"source";s:9:"TweetDeck";s:12:"contributors";s:0:"";s:9:"truncated";s:0:"";s:2:"id";s:19:"1.3768914138629E+17";s:4:"text";s:35:"@cyprienlaleau
    je t'ai répondu. :)";}s:13:"is_translator";s:0:"";s:18:"profile_link_color";s:6:"088253";s:20:"contributors_enabled";s:0:"";s:11:"geo_enabled";s:1:"1";s:34:"profile_background_image_url_https";s:49:"https://si0.twimg.com/images/themes/theme3/bg.gif";s:16:"favourites_count";s:1:"0";s:10:"created_at";s:30:"Sun
    Oct 04 15:34:43 +0000 2009";s:24:"profile_background_color";s:6:"EDECE9";s:11:"screen_name";s:6:"talus_";s:21:"show_all_inline_media";s:0:"";s:23:"profile_background_tile";s:0:"";s:2:"id";s:8:"79756673";s:4:"lang";s:2:"en";s:26:"profile_sidebar_fill_color";s:6:"E3E2DE";s:23:"profile_image_url_https";s:92:"https://si0.twimg.com/profile_images/1399907993/2824ef746269b35091240ed6e66e21a5_normal.jpeg";}}}}}}
---
<p style="text-align: justify;">Mon travail en tant que développeur qualité a pour tâche principale de m'assurer que les produits de l'entreprise (enfin, <em>le</em> produit dans le cas de mon entreprise) soient fonctionnels et présentent un gage de qualité. OK.</p>
<p style="text-align: justify;">Pour s'assurer que ce soit bien le cas, et que le tout tourne de façon correcte, on dispose d'outils tels des tests unitaires et des tests fonctionnels (et probablement d'autres à venir, qui dépendront des besoins manifestés). Ayant fini de dessiner une première architecture de tests fonctionnels à l'aide de Behat, mon travail du moment est d'épurer les tests PHPUnit pour qu'ils puissent fonctionner en "standalone", c'est à dire de façon complètement autonome et de faire ce qu'ils ont à faire : tester réellement les modules de façon unitaire.</p>
<p style="text-align: justify;"><!--more--><img title="Lire la suite…" alt="" src="http://baptiste.xn--clavi-fsa.net/wp-includes/js/tinymce/plugins/wordpress/img/trans.gif" />Avant mon arrivée, ces tests faisaient une couche fonctionnelle (maintenant plus ou moins assurée par Behat), en se connectant à une base de données. Qu'il faut remettre à zéro à chaque lancement de la test suite. Ceci n'est pas vraiment l'optique d'une suite de tests unitaires : celle-ci doit être complètement indépendante de l'environnement dans laquelle elle est lancée. On test ce qu'on a à tester, et le reste, on est censé l'émuler.</p>
<p style="text-align: justify;">Le truc, c'est que des fois, ces modules qu'on doit tester doivent récupérer des données issues d'une base de donnée. Ou d'autres dépendances, par exemple en Symfony un accès à la couche de la gestion de sécurité. Mais c'est lourd de tout charger, spécialement si on fonctionne de manière unitaire, c'est à dire que chaque tests puissent se lancer indépendamment les uns des autres, en remettant à zéro tout se qui s'est passé auparavant. Pour cela, PHPUnit offre un outil assez puissant : <strong>les Mocks</strong> (ou "bouchons", comme cela est traduit de façon assez moche en français...). On indique qu'on veut mocker une classe, une interface, mais toutes les méthodes, sauf mention contraire, renverront <code>null</code>. Juste pour servir à établir des dépendances.</p>
<p style="text-align: justify;">OK, pourquoi pas. Mais des fois, ces mocks doivent avoir un certain comportement pour que le service fonctionne. Le meilleur comportement que j'ai en tête, c'est celui de la base de données. Il s'agit en fait de l'émuler, sans pour autant stocker des données de façon physique. Quand on utilise un ORM, c'est pas si facile que de faire "juste un simple mock". Il faut essayer de stocker les données quelque part, les récupérer comme on le fait normalement (par des repositories si on utilise Doctrine par exemple), ... En plus, avec les <a href="http://fr.php.net/traits">traits, introduits avec PHP 5.4</a>, la tâche est un peu simplifiée, qui permet d'utiliser ce genre d'opérations avec un simple <code>use MockEntityManager</code>. Et zou, on a accès à l'<code>EntityManager</code> (ou plutôt une partie intéressante de celui-ci, émulée bien évidemment), à une mini gestion de <code>Repository</code>, d'entités, ...</p>
[gist id=4407655 file=MockEntityManager.php]
<p style="text-align: justify;">Ce qui en fait une sorte d'ORM, sans l'être non plus, car sans avoir tout le bouzin embarqué avec, ou même <em>la</em> fonctionnalité d'un ORM : la persistence des données. Alors qu'habituellement, ces données sont persistées d'une manière ou d'une autre par le biais de votre SGBD favori, dans le cas d'un mock, vu qu'on ne veut juste les avoir que la durée du tests, on peut faire fi de cet aspect, et se contenter de les mettre quelque part en mémoire. C'est un peu le but de l'outil mock que j'ai en place. Je vous laisse essayer de jouer avec. :)</p>
<p style="text-align: justify;">Si vous explorez un peu le gist, outre le fichier du mock de l'entity manager, j'ai également créé un mock pour le <code>SecurityContext</code> de Symfony, qui lui reste beaucoup plus simple que celui de l'<code>EntityManager</code>.</p>
<p style="text-align: justify;">Have fun. :)</p>
